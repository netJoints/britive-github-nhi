name: Update Financial Report to S3 via Britive
on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "public/index.html"

permissions:
  contents: read
  id-token: write

jobs:
  deploy-financial-report-to-s3:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Configure pybritive and AWS CLI
        run: |
          pip3 install pybritive
          pip3 install awscli

      - name: Configure and Checkout Britive JIT Profile
        run: |
          mkdir -p ~/.aws
          pybritive configure tenant --tenant demo --no-prompt
          pybritive configure global --tenant demo --format json --no-prompt
          pybritive configure update profile-aliases default "AWS/123750444551 (Sigma Stage)/AWS Creative Profile - S3 Full Access"
          cat << EOF > ~/.aws/credentials
          [default]
          credential_process=pybritive checkout default -m awscredentialprocess -P github-britive
          EOF
          aws sts get-caller-identity

      - name: Configure S3 Bucket for JIT Access
        run: |
          # Disable Block Public Access settings
          aws s3api put-public-access-block \
            --bucket app-files-devops \
            --public-access-block-configuration \
            "BlockPublicAcls=false,IgnorePublicAcls=false,BlockPublicPolicy=false,RestrictPublicBuckets=false"
          
          # Apply bucket policy for public read access
          cat > bucket-policy.json << 'EOF'
          {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Sid": "PublicReadGetObject",
                "Effect": "Allow",
                "Principal": "*",
                "Action": "s3:GetObject",
                "Resource": "arn:aws:s3:::app-files-devops/*"
              }
            ]
          }
          EOF
          aws s3api put-bucket-policy --bucket app-files-devops --policy file://bucket-policy.json

      - name: Upload index.html to S3 using JIT Creds
        run: |
          aws s3 cp public/index.html s3://app-files-devops/index.html
          echo "Successfully uploaded index.html to s3://app-files-devops"
          echo "Website URL: http://app-files-devops.s3-website.us-east-2.amazonaws.com"

      - name: Check In Britive Profile Revoke JIT Access
        if: always()
        run: pybritive checkin default -P github-britive
